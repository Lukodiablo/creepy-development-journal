# Malware and Dependency-Fix Plan

This document summarizes the investigation and plan to fix the critical dependency issues and malware in the Creepy project.

## 1. The Initial Problem

The project has 204 critical dependency conflicts, including several packages with known malware. This issue arose after an attempt to fix 4 deprecated dependencies.

## 2. `npm audit` Findings

An `npm audit` revealed several critical vulnerabilities, including malware in the following packages:

*   `color-convert`
*   `color-name`
*   `debug`
*   `is-arrayish`

These vulnerabilities are present in many of the project's dependencies.

### Malware Details

The malware attack, which began on September 8, 2025, involves malicious code designed to steal cryptocurrency. It was initiated after a core developer's npm account was compromised via a phishing campaign. Malicious versions of numerous popular packages were published to the npm registry. The malware is designed to intercept and manipulate web3 and cryptocurrency-related activities within a user's browser, and can rewrite payment destinations, redirecting funds and approvals to accounts controlled by the attacker.

## 3. Affected Top-Level Dependencies

The following top-level dependencies are pulling in the vulnerable packages:

*   `@genkit-ai/firebase`
*   `@google-cloud/translate`
*   `eslint`
*   `genkit-cli`
*   `next`
*   `pm2`
*   `langchain`

## 4. Investigation into Alternatives

We investigated replacing the vulnerable packages, but we could not find any "drop-in" replacements for `color-convert`, which is the most widespread issue.

## 5. The Plan: Merge the Best of Both Builds

The current plan is to abandon the broken build and work from the more stable legacy build located in `~/overhaul/creepy`.

However, to avoid losing the recent work, we will copy the new features and bug fixes from the broken build to the legacy build.

### Changed Source Code Files

The following source code files were identified as being different between the two builds:

- [ ] `src/ai/flows/ask-wiki-flow.ts`
- [ ] `src/ai/flows/generate-joke-flow.ts`
- [ ] `src/ai/flows/generate-quest-flow.ts`
- [ ] `src/ai/flows/generate-riddle-flow.ts`
- [ ] `src/ai/flows/get-moon-phase-flow.ts`
- [ ] `src/ai/flows/merge-users-flow.ts`
- [ ] `src/ai/flows/old-ask-wiki-flow.ts`
- [ ] `src/ai/flows/suggest-bot-enhancements.ts`
- [ ] `src/app/actions.ts`
- [ ] `src/app/api/ask-wiki/route.ts`
- [ ] `src/app/api/auth/callback/route.ts`
- [ ] `src/app/dashboard/global-settings/page.tsx`
- [ ] `src/app/dashboard/page.tsx`
- [ ] `src/app/dashboard/select-guild/client.tsx`
- [ ] `src/app/dashboard/select-guild/page.tsx`
- [ ] `src/app/demo/page.tsx`
- [ ] `src/app/feedback/page.tsx`
- [ ] `src/app/handbook/page.tsx`
- [ ] `src/app/layout.tsx`
- [ ] `src/app/page.tsx`
- [ ] `src/app/page1.tsx`
- [ ] `src/app/roadmap/page.tsx`
- [ ] `src/bot/MusicManager.js`
- [ ] `src/bot/bot.ts`
- [ ] `src/bot/commands/adventure.ts`
- [ ] `src/bot/commands/apply.ts`
- [ ] `src/bot/commands/boost.ts`
- [ ] `src/bot/commands/bugreport.ts`
- [ ] `src/bot/commands/buy.ts`
- [ ] `src/bot/commands/creepy.ts`
- [ ] `src/bot/commands/dig.ts`
- [ ] `src/bot/commands/fight.ts`
- [ ] `src/bot/commands/fish.ts`
- [ ] `src/bot/commands/give.ts`
- [ ] `src/bot/commands/heist.ts`
- [ ] `src/bot/commands/help.ts`
- [ ] `src/bot/commands/hunt.ts`
- [ ] `src/bot/commands/inventory.ts`
- [ ] `src/bot/commands/jobs.ts`
- [ ] `src/bot/commands/merge.ts`
- [ ] `src/bot/commands/profile.ts`
- [ ] `src/bot/commands/quest.ts`
- [ ] `src/bot/commands/quit.ts`
- [ ] `src/bot/commands/resign.ts`
- [ ] `src/bot/commands/riddle.ts`
- [ ] `src/bot/commands/shop.ts`
- [ ] `src/bot/commands/translate.ts`
- [ ] `src/bot/deploy-commands.ts`
- [ ] `src/components/dashboard/BotStats.tsx`
- [ ] `src/components/dashboard/DashboardClientPage.tsx`
- [ ] `src/components/dashboard/FreeModerationSettings.tsx`
- [ ] `src/components/dashboard/GuildSelector.tsx`
- [ ] `src/components/dashboard/GuildSelectorClient.tsx`
- [ ] `src/components/dashboard/Leaderboard.tsx`
- [ ] `src/components/dashboard/QuestSettings.tsx`
- [ ] `src/components/dashboard/pro/AnalyticsSettings.tsx`
- [ ] `src/components/dashboard/pro/ModerationSettings.tsx`
- [ ] `src/components/dashboard/pro/MoodSettings.tsx`
- [ ] `src/components/dashboard/pro/OnboardingSettings.tsx`
- [ ] `src/components/dashboard/pro/ProSettings.tsx`
- [ ] `src/components/dashboard/pro/RedeemCode.tsx`
- [ ] `src/components/dashboard/pro/Severity.tsx`
- [ ] `src/components/dashboard/pro/Subscription.tsx`
- [ ] `src/components/ui/sidebar.tsx`
- [ ] `src/components/wiki/WikiChat.tsx`
- [ ] `src/firebase/admin.ts`
- [ ] `src/firebase/init.ts`
- [ ] `src/hooks/use-toast.ts`
- [ ] `src/lib/auth.ts`
- [ ] `src/lib/types.ts`
- [ ] `src/services/hunting.ts`
- [ ] `src/services/items.ts`
- [ ] `src/services/jobs.ts`
- [ ] `src/tailwind.config.ts`

## 6. Files with Potential Issues

This section lists files that have been analyzed and found to have potential issues when copying them to the legacy build.

*   **`src/bot/MusicManager.js`**: This file depends on `@discordjs/voice`. The new build uses version `^0.17.0`, while the legacy build uses `^0.16.1`. There is a breaking change between these versions related to `DiscordGatewayAdapterCreator`. Copying this file will likely cause a crash. We will need to either skip this file or modify it to be compatible with the older version.
*   **`src/bot/bot.ts`**: This file depends on the `dotenv` package, which is not present in the legacy build's `package.json`. To use this file, we will need to add `dotenv` to the dependencies of the legacy build.
*   **`src/bot/deploy-commands.ts`**: This file depends on the `dotenv` package, which is not present in the legacy build's `package.json`. To use this file, we will need to add `dotenv` to the dependencies of the legacy build.
*   **`src/ai/flows/ask-wiki-flow.ts`**: This file depends on `langchain`, which is a vulnerable package (due to its dependency on `debug` malware). Copying this file will bring in the `debug` malware. We will need to either skip this file or find a way to update/override the `debug` dependency.

7. Current Plan: Rigorous File-by-File Analysis and Migration
The current plan is to analyze each changed file individually to ensure it is safe before copying it from the broken build to the legacy build. The following multi-step analysis protocol must be applied to each file in the "Changed Source Code Files" list.
7.1 Analysis Protocol for Each File
For each file, we will perform the following steps:
Identify Direct Imports: Parse the file's source code to list all external packages it directly imports (e.g., import { ... } from 'langchain';).
Analyze Transitive Dependencies: Using the broken build's package-lock.json, trace each direct import to determine the exact versions of all its transitive dependencies (the dependencies of its dependencies).
Cross-Reference with Malware List: Compare the full list of resolved dependencies (both direct and transitive) and their specific versions against our list of known malware packages:
color-convert
color-name
debug
is-arrayish
Check for Legacy Build Compatibility:
Verify that all necessary direct dependencies exist in the legacy build's package.json. If not, note that the dependency must be added (e.g., dotenv).
Check for version mismatches that would introduce breaking changes (e.g., @discordjs/voice ^0.17.0 vs. ^0.16.1).
Categorize and Document: Based on the analysis, mark each file with one of the following statuses in the checklist:
[x] Safe to Copy: The file and its entire dependency tree are free of known malware and compatible with the legacy build.
[~] Requires Action: The file is safe but requires a change in the legacy build's package.json (e.g., adding a new dependency like dotenv or carefully upgrading an existing one).
[!] Blocked: The file introduces a known malware package through its dependency tree (e.g., ask-wiki-flow.ts via langchain -> debug). These files will be skipped initially and addressed last.
7.2 Migration Execution
Once the analysis is complete, we will proceed with the migration in two phases:
Phase 1: Safe & Actionable Files:
First, modify the legacy build's package.json to incorporate all changes identified for files marked with [~]. Run npm install and ensure the legacy build remains stable.
Next, copy all files marked with [x] and [~] from the broken build to the legacy build.
Phase 2: Blocked Files:
Address each file marked with [! ] on a case-by-case basis. This will involve finding safe alternatives to the vulnerable packages, refactoring the code to remove the dependency, or waiting for security patches from the package maintainers.
